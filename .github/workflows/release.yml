name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Build universal binary
        run: |
          cd app
          swift build -c release --arch arm64 --arch x86_64 -Xswiftc -strict-concurrency=minimal
      
      - name: Create .app bundle
        run: |
          BUILD_DIR="build"
          APP_NAME="Herd"
          APP_BUNDLE="$BUILD_DIR/$APP_NAME.app"
          
          mkdir -p "$BUILD_DIR"
          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"
          
          # Copy universal binary
          cp "app/.build/apple/Products/Release/Herd" "$APP_BUNDLE/Contents/MacOS/$APP_NAME"
          chmod +x "$APP_BUNDLE/Contents/MacOS/$APP_NAME"
          
          # Create Info.plist
          cat > "$APP_BUNDLE/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>Herd</string>
              <key>CFBundleIdentifier</key>
              <string>com.qouter.herd</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>Herd</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${GITHUB_REF#refs/tags/v}</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
          </dict>
          </plist>
          EOF
      
      - name: Code sign
        run: |
          # Ad-hoc code signing (no developer certificate required)
          codesign --force --deep -s - build/Herd.app
      
      - name: Create release archive
        run: |
          cd build
          # Create archive with app and hooks
          mkdir -p Herd-release
          cp -r Herd.app Herd-release/
          cp -r ../hooks Herd-release/
          
          # Create zip
          zip -r Herd-macos-universal.zip Herd-release
          mv Herd-macos-universal.zip ../
          cd ..
      
      - name: Generate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 Herd-macos-universal.zip | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "$SHA256" > Herd-macos-universal.zip.sha256
          echo "SHA256: $SHA256"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Herd-macos-universal.zip
            Herd-macos-universal.zip.sha256
          body: |
            ## Herd ${{ github.ref_name }}
            
            **macOS menu bar app for Claude Code agents**
            
            ### Installation
            
            #### Via Homebrew (recommended)
            ```bash
            brew tap qouter/tap
            brew install herd
            ```
            
            #### Manual Installation
            1. Download `Herd-macos-universal.zip`
            2. Unzip and copy `Herd.app` to `/Applications/`
            3. Install hooks (see README)
            
            ### SHA256
            ```
            ${{ steps.sha256.outputs.sha256 }}
            ```
            
            ### What's New
            See CHANGELOG.md for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Homebrew Tap
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          if [ -z "$TAP_GITHUB_TOKEN" ]; then
            echo "⚠️  TAP_GITHUB_TOKEN not set, skipping tap update"
            exit 0
          fi
          
          VERSION="${GITHUB_REF#refs/tags/v}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"
          
          # Clone tap repo
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/Qouter/homebrew-tap.git tap-repo
          cd tap-repo
          
          # Update formula
          sed -i '' "s|version \".*\"|version \"$VERSION\"|" Formula/herd.rb
          sed -i '' "s|/download/v[^/]*/|/download/v$VERSION/|" Formula/herd.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"$SHA256\"|" Formula/herd.rb
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/herd.rb
          git commit -m "herd: update to $VERSION" || echo "No changes to commit"
          git push origin main
          
          echo "✓ Updated Homebrew tap to $VERSION"
