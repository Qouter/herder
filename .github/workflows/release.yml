name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Build universal binary
        run: |
          cd app
          swift build -c release --arch arm64 --arch x86_64 -Xswiftc -strict-concurrency=minimal
      
      - name: Create .app bundle
        run: |
          mkdir -p build/Herder.app/Contents/MacOS build/Herder.app/Contents/Resources
          cp app/.build/apple/Products/Release/Herder build/Herder.app/Contents/MacOS/Herder
          chmod +x build/Herder.app/Contents/MacOS/Herder
          VERSION="${GITHUB_REF#refs/tags/v}"
          cat > build/Herder.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>Herder</string>
              <key>CFBundleIdentifier</key>
              <string>com.qouter.herder</string>
              <key>CFBundleName</key>
              <string>Herder</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF
      
      - name: Code sign and package
        run: |
          codesign --force --deep -s - build/Herder.app
          xattr -cr build/Herder.app
          mkdir -p build/Herder-release
          cp -r build/Herder.app build/Herder-release/
          cp -r hooks build/Herder-release/
          cd build && zip -r ../Herder-macos-universal.zip Herder-release
      
      - name: Generate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 Herder-macos-universal.zip | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "$SHA256" > Herder-macos-universal.zip.sha256
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Herder-macos-universal.zip
            Herder-macos-universal.zip.sha256
          body: |
            ## Herder ${{ github.ref_name }}
            
            ```bash
            brew tap qouter/tap && brew install herder
            ```
            
            SHA256: `${{ steps.sha256.outputs.sha256 }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Homebrew Tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          if [ -z "$TAP_GITHUB_TOKEN" ]; then exit 0; fi
          VERSION="${GITHUB_REF#refs/tags/v}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/Qouter/homebrew-tap.git tap-repo
          cd tap-repo
          sed -i '' "s|version \".*\"|version \"$VERSION\"|" Formula/herder.rb
          sed -i '' "s|/download/v[^/]*/|/download/v$VERSION/|" Formula/herder.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"$SHA256\"|" Formula/herder.rb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/herder.rb
          git commit -m "herder: update to $VERSION" || true
          git push origin main
